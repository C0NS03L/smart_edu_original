<% content_for :title, t('principals.manage_codes.page_title') %>
<div class="container mx-auto p-4">
  <h1 class="mb-6 text-3xl font-bold"><%= t('principals.manage_codes.heading') %></h1>

  <div class="mb-6 flex items-center justify-between">
    <%= link_to t('principals.manage_codes.generate_new_code'), generate_code_principal_path, class: 'btn btn-primary' %>
    <%= render 'shared/back_to_dashboard_button' %>
  </div>

  <div class="overflow-x-auto">
    <div id="flash"><%= render 'shared/flash' %></div>
    <% if @enrollment_codes.any?(&:fully_used?) %>
      <div class="mb-2 flex justify-end">
        <%= button_to delete_used_codes_principal_path,
                      method: :delete,
                      class: 'btn btn-sm btn-error',
                      data: {
                        turbo_confirm: t('common.enrollment_codes.delete_used_confirm')
                      } do %>
          <%= t('common.enrollment_codes.delete_used_codes') %>
        <% end %>
      </div>
    <% end %>
    <div class="mb-4 flex items-center space-x-2">
      <span><%= t('common.enrollment_codes.filter') %>:</span>
      <%= link_to t('common.enrollment_codes.all'),
                  manage_codes_principal_path,
                  class: "btn btn-sm #{params[:filter].blank? ? 'btn-primary' : 'btn-outline'}" %>
      <%= link_to t('common.enrollment_codes.active'),
                  manage_codes_principal_path(filter: 'active'),
                  class: "btn btn-sm #{params[:filter] == 'active' ? 'btn-primary' : 'btn-outline'}" %>
      <%= link_to t('common.enrollment_codes.used_up'),
                  manage_codes_principal_path(filter: 'used_up'),
                  class: "btn btn-sm #{params[:filter] == 'used_up' ? 'btn-primary' : 'btn-outline'}" %>
    </div>

    <%= render 'enrollment_codes_table', enrollment_codes: @enrollment_codes %>
  </div>
</div>

<script>
  function copyCodeFromMessage(elementId) {
    const element = document.getElementById(elementId)
    const textToCopy = element.textContent

    navigator.clipboard
      .writeText(textToCopy)
      .then(() => {
        // Create a temporary alert to show the copy was successful
        const alertDiv = document.createElement('div')
        alertDiv.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg'
        alertDiv.textContent = '<%= t('common.enrollment_codes.copied_message') %>'
        document.body.appendChild(alertDiv)

        setTimeout(() => {
          alertDiv.remove()
        }, 2000)
      })
      .catch((err) => {
        console.error('Failed to copy text: ', err)
      })
  }
</script>

<table id="enrollment-codes-table" class="table w-full">
  <thead>
    <tr>
      <th><%= t('common.enrollment_codes.code') %></th>
      <th><%= t('common.enrollment_codes.type') %></th>
      <th><%= t('common.enrollment_codes.usage') %></th>
      <th><%= t('common.enrollment_codes.created') %></th>
      <th><%= t('common.enrollment_codes.actions') %></th>
    </tr>
  </thead>
  <tbody>
    <% if enrollment_codes.present? %>
      <% enrollment_codes.each do |code| %>
        <tr id="code-<%= code.id %>" class="<%= code.fully_used? ? 'bg-gray-100' : '' %>">
          <td><span id="code-text-<%= code.id %>"><%= code.code %></span></td>
          <td>
            <% if defined?(show_type) && show_type %>
              <%= code.account_type == 'student' ? t('common.enrollment_codes.student_type') : t('common.enrollment_codes.staff_type') %>
            <% else %>
              <%= t('common.enrollment_codes.student_type') %>
            <% end %>
          </td>
          <td>
            <% if code.fully_used? %>
              <span class="badge badge-error text-white">
                <%= code.usage_count %> / <%= code.usage_limit %>
                <%= t('common.enrollment_codes.used_up') %>
              </span>
            <% else %>
              <span class="<%= code.usage_count > 0 ? 'text-amber-600' : 'text-green-600' %>">
                <%= code.usage_count || 0 %> / <%= code.usage_limit || 'âˆž' %>
              </span>
            <% end %>
          </td>
          <td><%= code.created_at.strftime('%b %d, %Y') %></td>
          <td class="flex space-x-2">
            <button
              onclick="copyCodeFromMessage('code-text-<%= code.id %>')"
              class="btn btn-sm btn-outline"
              title="<%= t('common.enrollment_codes.copy_tooltip') %>"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                />
              </svg>
            </button>
            <%= button_to delete_path.call(code),
                          method: :delete,
                          class: 'btn btn-sm btn-error',
                          form: {
                            data: {
                              turbo: true
                            }
                          },
                          data: {
                            turbo_confirm: t('common.enrollment_codes.delete_confirm')
                          } do %>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
            <% end %>
          </td>
        </tr>
      <% end %>
    <% else %>
      <tr>
        <td colspan="5" class="py-4 text-center"><%= t('common.enrollment_codes.no_codes_found') %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<script>
  function copyCodeFromMessage(elementId) {
    const element = document.getElementById(elementId)
    const fullText = element.textContent

    // Extract just the code (format: "XXX-YYYYYYYY")
    const codeMatch = fullText.match(/([A-Z]{3}-[0-9A-F]{8})/)
    const textToCopy = codeMatch ? codeMatch[0] : fullText

    navigator.clipboard
      .writeText(textToCopy)
      .then(() => {
        // Create a temporary alert to show the copy was successful
        const alertDiv = document.createElement('div')
        alertDiv.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg'
        alertDiv.textContent = '<%= t('common.enrollment_codes.copied_message') %>'
        document.body.appendChild(alertDiv)

        setTimeout(() => {
          alertDiv.remove()
        }, 2000)
      })
      .catch((err) => {
        console.error('Failed to copy text: ', err)
      })
  }
</script>
